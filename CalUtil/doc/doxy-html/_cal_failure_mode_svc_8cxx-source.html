<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>CalUtil: CalFailureModeSvc.cxx Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>CalFailureModeSvc.cxx</h1><a href="_cal_failure_mode_svc_8cxx.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">// Implementation file for CalFailureModeSvc which handles the failure mode testing</span>
00002 <span class="comment">// for the CAL.</span>
00003 <span class="comment">// </span>
00004 <span class="comment">//</span>
00005 <span class="comment">// $Header$</span>
00006 <span class="comment">//</span>
00007 <span class="comment">// Author: Richard Dubois</span>
00008 
00009 
00010 <span class="preprocessor">#include "<a class="code" href="_cal_failure_mode_svc_8h.html">CalUtil/CalFailureModeSvc.h</a>"</span>
00011 
00012 
00013 <span class="preprocessor">#include "GaudiKernel/MsgStream.h"</span>
00014 <span class="preprocessor">#include "GaudiKernel/SvcFactory.h"</span>
00015 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00016 
00017 
00018 <span class="comment">// declare the service factories for the CalFailureModeSvc</span>
00019 
00020 <span class="keyword">static</span> SvcFactory&lt;CalFailureModeSvc&gt; a_factory;
<a name="l00021"></a><a class="code" href="_cal_failure_mode_svc_8cxx.html#a1">00021</a> <span class="keyword">const</span> ISvcFactory&amp; <a class="code" href="_cal_failure_mode_svc_8cxx.html#a1">CalFailureModeSvcFactory</a> = a_factory; 
00022 
00023 
00024 
<a name="l00025"></a><a class="code" href="class_cal_failure_mode_svc.html#a0">00025</a> <a class="code" href="class_cal_failure_mode_svc.html#a0">CalFailureModeSvc::CalFailureModeSvc</a>(<span class="keyword">const</span> std::string&amp; name,ISvcLocator* svc) : Service(name,svc)
00026 {
00027     <span class="comment">// Purpose and Method: Constructor - Declares and sets default properties</span>
00028     <span class="comment">//                     </span>
00029     <span class="comment">// Inputs: service name and locator </span>
00030     <span class="comment">//         </span>
00031     <span class="comment">// Outputs: None</span>
00032     <span class="comment">// Dependencies: None</span>
00033     <span class="comment">// Restrictions and Caveats:  None</span>
00034     
00035         
00036     <span class="comment">// declare the properties</span>
00037         
00038         
00039     declareProperty(<span class="stringliteral">"towerList"</span>, <a class="code" href="class_cal_failure_mode_svc.html#r0">m_towerListProperty</a>);
00040     declareProperty(<span class="stringliteral">"towerAfeeList"</span>, <a class="code" href="class_cal_failure_mode_svc.html#r1">m_towerAfeeListProperty</a>);
00041     declareProperty(<span class="stringliteral">"towerControllerList"</span>, <a class="code" href="class_cal_failure_mode_svc.html#r2">m_towerControllerListProperty</a>);
00042 }
00043 
00044 
00045 
<a name="l00046"></a><a class="code" href="class_cal_failure_mode_svc.html#a6">00046</a> StatusCode  <a class="code" href="class_cal_failure_mode_svc.html#a6">CalFailureModeSvc::queryInterface</a> (<span class="keyword">const</span> IID&amp; riid, <span class="keywordtype">void</span> **ppvIF) {
00047         
00048         
00049     <span class="keywordflow">if</span> (IID_ICalFailureModeSvc == riid) {
00050         *ppvIF = dynamic_cast&lt;ICalFailureModeSvc*&gt; (<span class="keyword">this</span>);
00051         <span class="keywordflow">return</span> StatusCode::SUCCESS;
00052     }
00053     <span class="keywordflow">else</span> {
00054         <span class="keywordflow">return</span> Service::queryInterface (riid, ppvIF);
00055     }
00056 }
00057 
00058 
00059 
<a name="l00060"></a><a class="code" href="class_cal_failure_mode_svc.html#a7">00060</a> <span class="keyword">const</span> IID&amp;  <a class="code" href="class_cal_failure_mode_svc.html#a7">CalFailureModeSvc::type</a> ()<span class="keyword"> const </span>{
00061     <span class="keywordflow">return</span> IID_ICalFailureModeSvc;
00062 }
00063 
00064 
00065 
<a name="l00066"></a><a class="code" href="class_cal_failure_mode_svc.html#a1">00066</a> StatusCode <a class="code" href="class_cal_failure_mode_svc.html#a1">CalFailureModeSvc::initialize</a> () 
00067 {
00068     <span class="comment">// Purpose and Method: Initialize the lists of dead units</span>
00069     <span class="comment">//                     </span>
00070     <span class="comment">// Inputs: None        </span>
00071     <span class="comment">// Outputs: None</span>
00072     <span class="comment">// Dependencies: None</span>
00073     <span class="comment">// Restrictions and Caveats:  None</span>
00074     
00075         
00076     StatusCode  status = StatusCode::SUCCESS;
00077         
00078     <span class="comment">// Open the message log</span>
00079     MsgStream log( msgSvc(), name() );
00080     
00081         
00082     <span class="comment">// Call super-class</span>
00083     Service::initialize ();
00084         
00085     <span class="comment">// Bind all of the properties for this service</span>
00086     <span class="keywordflow">if</span> ( (status = setProperties()).isFailure() ) {
00087         log &lt;&lt; MSG::ERROR &lt;&lt; <span class="stringliteral">"Failed to set properties"</span> &lt;&lt; endreq;
00088     }
00089         
00090     <a class="code" href="class_cal_failure_mode_svc.html#r3">m_failureModes</a> = 0;
00091     <a class="code" href="class_cal_failure_mode_svc.html#b3">processTowerList</a>();
00092     <a class="code" href="class_cal_failure_mode_svc.html#b4">processTowerAfeeList</a>();
00093     <a class="code" href="class_cal_failure_mode_svc.html#b5">processTowerControllerList</a>();
00094         
00095     <span class="keywordflow">return</span> StatusCode::SUCCESS;
00096 }
00097 
00098 
<a name="l00099"></a><a class="code" href="class_cal_failure_mode_svc.html#a3">00099</a> StatusCode <a class="code" href="class_cal_failure_mode_svc.html#a3">CalFailureModeSvc::finalize</a> () {<span class="keywordflow">return</span> StatusCode::SUCCESS;}
00100 
00101 
<a name="l00102"></a><a class="code" href="class_cal_failure_mode_svc.html#b4">00102</a> <span class="keywordtype">void</span> <a class="code" href="class_cal_failure_mode_svc.html#b4">CalFailureModeSvc::processTowerAfeeList</a>() {
00103     <span class="comment">// Purpose and Method: process the jobOptions input lists of (tower,layer) pairs</span>
00104     <span class="comment">//                     </span>
00105         
00106     MsgStream log(msgSvc(), name());
00107         
00108     <span class="keyword">const</span> std::vector&lt;std::string&gt;&amp; theTowers = <a class="code" href="class_cal_failure_mode_svc.html#r1">m_towerAfeeListProperty</a>.value( );
00109     <span class="keywordflow">if</span> (theTowers.size() == 0) <span class="keywordflow">return</span>;
00110         
00111     <a class="code" href="class_cal_failure_mode_svc.html#r3">m_failureModes</a> = <a class="code" href="class_cal_failure_mode_svc.html#r3">m_failureModes</a> || 1 &lt;&lt; <a class="code" href="class_cal_failure_mode_svc.html#w4w1">TOWERAFEE</a>;
00112         
00113     log &lt;&lt; MSG::INFO &lt;&lt; <span class="stringliteral">"Towers and AFEEs to kill "</span> &lt;&lt; endreq;
00114         
00115         
00116     std::vector&lt;std::string&gt;::const_iterator it;
00117     std::vector&lt;std::string&gt;::const_iterator itend = theTowers.end( );
00118         
00119     <span class="keywordflow">for</span> (it = theTowers.begin(); it != itend; it++) {
00120         <span class="keywordtype">int</span> len = (*it).size();
00121         <span class="keywordtype">int</span> delimPos = (*it).find_first_of(<span class="charliteral">'_'</span>);
00122         <span class="keywordtype">int</span> tower = atoi((*it).substr(0, delimPos).c_str());
00123         <span class="keywordtype">int</span> layer = atoi((*it).substr(delimPos+1, len-delimPos-1).c_str());
00124                 
00125         log &lt;&lt; MSG::INFO &lt;&lt; <span class="stringliteral">"Tower "</span> &lt;&lt; tower &lt;&lt; <span class="stringliteral">" AFEE "</span> &lt;&lt; layer &lt;&lt; endreq;
00126                 
00127         std::vector&lt;int&gt;&amp; curList = <a class="code" href="class_cal_failure_mode_svc.html#r5">m_towerAfeeList</a>[tower];
00128         curList.push_back(layer);                
00129     }
00130 }
00131 
<a name="l00132"></a><a class="code" href="class_cal_failure_mode_svc.html#b5">00132</a> <span class="keywordtype">void</span> <a class="code" href="class_cal_failure_mode_svc.html#b5">CalFailureModeSvc::processTowerControllerList</a>() {
00133     <span class="comment">// Purpose and Method: process the jobOptions input lists of (tower,layer) pairs</span>
00134     <span class="comment">//                     </span>
00135         
00136     MsgStream log(msgSvc(), name());
00137         
00138     <span class="keyword">const</span> std::vector&lt;std::string&gt;&amp; theTowers = <a class="code" href="class_cal_failure_mode_svc.html#r2">m_towerControllerListProperty</a>.value( );
00139     <span class="keywordflow">if</span> (theTowers.size() == 0) <span class="keywordflow">return</span>;
00140         
00141     <a class="code" href="class_cal_failure_mode_svc.html#r3">m_failureModes</a> = <a class="code" href="class_cal_failure_mode_svc.html#r3">m_failureModes</a> || 1 &lt;&lt; <a class="code" href="class_cal_failure_mode_svc.html#w4w2">TOWERCONTROL</a>;
00142         
00143     log &lt;&lt; MSG::INFO &lt;&lt; <span class="stringliteral">"Towers and Controllers to kill "</span> &lt;&lt; endreq;
00144         
00145         
00146     std::vector&lt;std::string&gt;::const_iterator it;
00147     std::vector&lt;std::string&gt;::const_iterator itend = theTowers.end( );
00148         
00149     <span class="keywordflow">for</span> (it = theTowers.begin(); it != itend; it++) {
00150         <span class="keywordtype">int</span> len = (*it).size();
00151         <span class="keywordtype">int</span> delimPos = (*it).find_first_of(<span class="charliteral">'_'</span>);
00152         <span class="keywordtype">int</span> tower = atoi((*it).substr(0, delimPos).c_str());
00153         <span class="keywordtype">int</span> layer = atoi((*it).substr(delimPos+1, len-delimPos-1).c_str());
00154                 
00155         log &lt;&lt; MSG::INFO &lt;&lt; <span class="stringliteral">"Tower "</span> &lt;&lt; tower &lt;&lt; <span class="stringliteral">" Controller "</span> &lt;&lt; layer &lt;&lt; endreq;
00156                 
00157         std::vector&lt;int&gt;&amp; curList = <a class="code" href="class_cal_failure_mode_svc.html#r6">m_towerControllerList</a>[tower];
00158         curList.push_back(layer);                
00159     }
00160 }
00161 
00162 
00163 
<a name="l00164"></a><a class="code" href="class_cal_failure_mode_svc.html#b3">00164</a> <span class="keywordtype">void</span> <a class="code" href="class_cal_failure_mode_svc.html#b3">CalFailureModeSvc::processTowerList</a>() {
00165         
00166         <span class="comment">// Purpose and Method: process the jobOptions input lists of towers</span>
00167     <span class="comment">//                     </span>
00168         
00169         
00170     MsgStream log(msgSvc(), name());
00171         
00172     <span class="keyword">const</span> std::vector&lt;std::string&gt;&amp; theTowers = <a class="code" href="class_cal_failure_mode_svc.html#r0">m_towerListProperty</a>.value( );
00173         
00174     <span class="keywordflow">if</span> (theTowers.size() == 0) <span class="keywordflow">return</span>;
00175         
00176     log &lt;&lt; MSG::INFO &lt;&lt; <span class="stringliteral">"Towers to kill "</span> &lt;&lt; endreq;
00177         
00178     <a class="code" href="class_cal_failure_mode_svc.html#r3">m_failureModes</a> = <a class="code" href="class_cal_failure_mode_svc.html#r3">m_failureModes</a> || 1 &lt;&lt; <a class="code" href="class_cal_failure_mode_svc.html#w4w0">TOWER</a>;
00179         
00180     std::vector&lt;std::string&gt;::const_iterator it;
00181     std::vector&lt;std::string&gt;::const_iterator itend = theTowers.end( );
00182         
00183     <span class="keywordflow">for</span> (it = theTowers.begin(); it != itend; it++) {
00184         <span class="keywordtype">int</span> tower = atoi((*it).c_str());
00185                 
00186         log &lt;&lt; MSG::INFO &lt;&lt; <span class="stringliteral">"Tower "</span> &lt;&lt; tower &lt;&lt; endreq;
00187                 
00188         <a class="code" href="class_cal_failure_mode_svc.html#r4">m_towerList</a>.push_back(tower);
00189     }
00190 }
00191 
00192 
00193 
<a name="l00194"></a><a class="code" href="class_cal_failure_mode_svc.html#b0">00194</a> <span class="keywordtype">bool</span> <a class="code" href="class_cal_failure_mode_svc.html#b0">CalFailureModeSvc::matchTower</a>(idents::CalXtalId <span class="keywordtype">id</span>) {
00195         
00196     <span class="comment">// Purpose and Method: check whether given id is in any of the identified lists</span>
00197         
00198     <span class="comment">//                     </span>
00199         
00200     
00201         
00202     <span class="keywordflow">if</span> (<a class="code" href="class_cal_failure_mode_svc.html#r4">m_towerList</a>.size() == 0) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00203         
00204     <span class="keywordtype">int</span> tower = <span class="keywordtype">id</span>.getTower();
00205         
00206     <span class="comment">// Search to see if this event id is among the list of ids we want to pause on</span>
00207         
00208     std::vector&lt;int&gt;::iterator loc = std::find(<a class="code" href="class_cal_failure_mode_svc.html#r4">m_towerList</a>.begin(), 
00209                                                 <a class="code" href="class_cal_failure_mode_svc.html#r4">m_towerList</a>.end(), tower);
00210     <span class="keywordflow">return</span> (loc != <a class="code" href="class_cal_failure_mode_svc.html#r4">m_towerList</a>.end());
00211 }
00212 
00213 
00214 
<a name="l00215"></a><a class="code" href="class_cal_failure_mode_svc.html#b1">00215</a> <span class="keywordtype">bool</span> <a class="code" href="class_cal_failure_mode_svc.html#b1">CalFailureModeSvc::matchTowerAfee</a>(idents::CalXtalId <span class="keywordtype">id</span>, idents::CalXtalId::XtalFace face) {
00216         
00217     <span class="comment">// Purpose and Method: look for the given id in the tower list</span>
00218     <span class="comment">//                     </span>
00219         
00220         
00221     <span class="keywordflow">if</span> (<a class="code" href="class_cal_failure_mode_svc.html#r5">m_towerAfeeList</a>.size() == 0) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00222         
00223     <span class="keywordtype">int</span> tower = <span class="keywordtype">id</span>.getTower();
00224     <span class="keywordtype">int</span> afee = 2*face + (!<span class="keywordtype">id</span>.isX());
00225         
00226     std::vector&lt;int&gt; &amp;afeeList = <a class="code" href="class_cal_failure_mode_svc.html#r5">m_towerAfeeList</a>[tower];
00227         
00228     <span class="comment">// Search to see if this (tower,AFEE) is among the list</span>
00229         
00230     std::vector&lt;int&gt;::iterator loc = std::find(afeeList.begin(), 
00231                                                 afeeList.end(), afee);
00232         
00233     <span class="keywordflow">return</span> (loc != afeeList.end());
00234         
00235 }
00236 
<a name="l00237"></a><a class="code" href="class_cal_failure_mode_svc.html#b2">00237</a> <span class="keywordtype">bool</span> <a class="code" href="class_cal_failure_mode_svc.html#b2">CalFailureModeSvc::matchTowerController</a>(idents::CalXtalId <span class="keywordtype">id</span>, idents::CalXtalId::XtalFace face) {
00238         
00239     <span class="comment">// Purpose and Method: look for the given id in the tower/controller list</span>
00240     <span class="comment">//                     </span>
00241         
00242         
00243     <span class="keywordflow">if</span> (<a class="code" href="class_cal_failure_mode_svc.html#r6">m_towerControllerList</a>.size() == 0) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00244         
00245     <span class="keywordtype">int</span> tower = <span class="keywordtype">id</span>.getTower();
00246     <span class="keywordtype">int</span> layer = <span class="keywordtype">id</span>.getLayer();
00247 
00248         <span class="comment">// primary controller has same numbering as AFEE; secondary is opposite</span>
00249     <span class="keywordtype">int</span> controller1 = 2*face + (!<span class="keywordtype">id</span>.isX());
00250         <span class="keywordtype">int</span> controller2 = (controller1+2)%4;
00251 
00252         <span class="comment">// x+ controller takes out all + side and layers 0,1 on neg side</span>
00253         <span class="comment">// y+ controller takes out all + side and layers 2,3 on neg side</span>
00254         <span class="keywordtype">bool</span> offController2P = (face == idents::CalXtalId::POS) &amp;&amp; (
00255                 (<span class="keywordtype">id</span>.isX() &amp;&amp; layer &lt; 4) 
00256                         || ( !<span class="keywordtype">id</span>.isX() &amp;&amp; layer &gt; 2));
00257         <span class="keywordtype">bool</span> offController2N = (face == idents::CalXtalId::NEG) &amp;&amp; (
00258                 (<span class="keywordtype">id</span>.isX() &amp;&amp; layer &gt; 3) 
00259                         || ( !<span class="keywordtype">id</span>.isX() &amp;&amp; layer &lt; 5));
00260 
00261     std::vector&lt;int&gt; &amp;controllerList = <a class="code" href="class_cal_failure_mode_svc.html#r6">m_towerControllerList</a>[tower];
00262         <span class="keywordflow">if</span> (controllerList.size() == 0) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00263     
00264         <span class="comment">// Search to see if this (tower,controller) is among the list</span>
00265         
00266     std::vector&lt;int&gt;::iterator loc1 = std::find(controllerList.begin(), 
00267                                                  controllerList.end(), 
00268                                                  controller1);                
00269     std::vector&lt;int&gt;::iterator loc2 = controllerList.end();
00270     <span class="keywordflow">if</span> (offController2P || offController2N) loc2 = std::find(controllerList.begin(), 
00271                 controllerList.end(), controller2);                
00272         
00273     <span class="keywordflow">return</span> (loc1 != controllerList.end() || loc2 != controllerList.end());
00274         
00275 }
00276 
00277 
00278 
<a name="l00279"></a><a class="code" href="class_cal_failure_mode_svc.html#a5">00279</a> <span class="keywordtype">bool</span> <a class="code" href="class_cal_failure_mode_svc.html#a5">CalFailureModeSvc::matchChannel</a>(idents::CalXtalId <span class="keywordtype">id</span>, idents::CalXtalId::XtalFace face) {
00280         
00281     <span class="comment">// Purpose and Method: look for the given id in the (tower,layer) list</span>
00282     <span class="comment">//                     </span>
00283         
00284         
00285     <span class="keywordflow">if</span> (<a class="code" href="class_cal_failure_mode_svc.html#b0">matchTower</a>(<span class="keywordtype">id</span>)) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00286     <span class="keywordflow">if</span> (<a class="code" href="class_cal_failure_mode_svc.html#b1">matchTowerAfee</a>(<span class="keywordtype">id</span>,face)) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00287     <span class="keywordflow">if</span> (<a class="code" href="class_cal_failure_mode_svc.html#b2">matchTowerController</a>(<span class="keywordtype">id</span>,face)) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00288         
00289     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00290         
00291 }
00292 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Tue Aug 24 19:18:38 2004 for CalUtil by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.8 </small></address>
</body>
</html>
